name: AuthService CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
    DOTNET_VERSION: '9.0'

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Restore dependencies
              run: dotnet restore

            - name: Build
              run: dotnet build --no-restore --configuration Release
            
            - name: Test with coverage
              run: |
                dotnet test --no-build --configuration Release \
                  /p:CollectCoverage=true \
                  /p:CoverletOutputFormat=cobertura \
                  /p:CoverletOutput=../coverage/ \
                  /p:Exclude="[xunit.*]*"
            
            - name: Upload coverage artifact
              uses: actions/upload-artifact@v4
              with:
                name: coverage-report
                path: |
                  coverage
                  coverage-report
            
            - name: Check coverage threshold
              run: |
                # Install reportgenerator with fallback
                dotnet tool install -g dotnet-reportgenerator-globaltool --version 5.1.23 || dotnet tool update -g dotnet-reportgenerator-globaltool --version 5.1.23
                export PATH="$PATH:$HOME/.dotnet/tools"
                reportgenerator -reports:coverage/coverage.cobertura.xml -targetdir:coverage-report -reporttypes:TextSummary 
                cat coverage-report/Summary.txt
                COVERAGE=$(grep -Po 'Line coverage: \K[0-9]+(\.[0-9]+)?' coverage-report/Summary.txt) 
                echo "Coverage: $COVERAGE%"
                python3 - <<EOF
                import re,sys
                s=open('coverage-report/Summary.txt').read()
                m = re.search(r'Line coverage: (\d+(\.\d+)?)%', s)
                if not m:
                    print('Could not parse coverage'); sys.exit(1)
                if float(m.group(1)) < 70.0:
                    print(f'Coverage {m.group(1)}% is below threshold'); sys.exit(1)
                print('Coverage OK')
                EOF
    
    publish-image:
        needs: build-and-test
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - uses: actions/checkout@v4
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v2
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: us-east-1
            
            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v1

            - name: Build and Push Docker Image
              env:
                ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                ECR_REPOSITORY: authservice
                IMAGE_TAG: ${{ github.sha }}
              run: |
                docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
                docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

            - name: Create image tag file
              run: echo ${{ github.sha }} > image-tag.txt
            - name: Upload image tag artifact
              uses: actions/upload-artifact@v4
              with:
                name: image-tag
                path: image-tag.txt
